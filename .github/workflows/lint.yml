name: Lint Python code with Ruff

on:
  workflow_dispatch:
  push:
    branches:
      - dev
  pull_request:

env:
  VAPOURSYNTH_VERSION: 72
  PYTHON_VERSION: 3.14

jobs:
  lint:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Set up uv
        uses: astral-sh/setup-uv@v7
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          enable-cache: true

      - name: Set up VapourSynth ${{ env.VAPOURSYNTH_VERSION }}
        uses: Jaded-Encoding-Thaumaturgy/setup-vapoursynth@v1
        with:
          vapoursynth-version: ${{ env.VAPOURSYNTH_VERSION }}

      # Option 1: Sync each plugin individually
      - name: ðŸ”„ Sync all plugin environments
        run: |
          set -euo pipefail
          for folder in */; do
            folder_name="${folder%/}"

            if [[ "$folder_name" == .* ]]; then
              continue
            fi

            if [ -f "$folder/uv.lock" ]; then
              echo "Syncing $folder_name"
              (cd "$folder_name" && uv sync --frozen)
            fi
          done

      - name: Run Ruff check
        id: ruff-check
        run: uvx ruff@latest check . --output-format=github

      - name: Run Ruff format
        id: ruff-format
        if: success() || (failure() && steps.ruff-check.conclusion == 'failure')
        run: uvx ruff@latest format --check --diff

      - name: Running mypy
        if: success() || (failure() && (steps.ruff-check.conclusion == 'failure' || steps.ruff-format.conclusion == 'failure'))
        run: uvx mypy@latest .
